<!DOCTYPE html>
<html>
<head>
    <title>Analytics - Modern Quiz (Improved)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/static/lib/fonts-local.css" rel="stylesheet">
    <script src="/static/lib/chart.min.js"></script>
    <script src="/static/lib/chartjs-plugin-datalabels.min.js"></script>
    <script src="/static/lib/jspdf.umd.min.js"></script>
    <script src="/static/lib/html2canvas.min.js"></script>
    <style>
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
    </style>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
            padding: 2rem;
            position: relative;
            overflow-x: hidden;
        }
        
        .container { 
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        
        .header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .title {
            font-size: 3rem;
            font-weight: 800;
            font-family: 'Poppins', sans-serif;
            margin-bottom: 0.5rem;
            color: #e2e8f0;
            text-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #cbd5e1;
            font-weight: 500;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }
        
        .stat-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(148, 163, 184, 0.3);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            transition: all 0.4s ease;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .stat-card:hover {
            transform: translateY(-10px) scale(1.05);
            background: rgba(51, 65, 85, 0.9);
            box-shadow: 0 20px 50px rgba(0,0,0,0.4);
            border-color: rgba(59, 130, 246, 0.5);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            font-family: 'Poppins', sans-serif;
            color: #e2e8f0;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            font-size: 1rem;
            color: #cbd5e1;
            font-weight: 500;
        }
        
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 3rem;
        }
        
        .chart-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(148, 163, 184, 0.3);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
            margin-bottom: 1rem;
            text-align: center;
            color: #e2e8f0;
        }
        
        .questions-analysis {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(148, 163, 184, 0.3);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            margin-bottom: 3rem;
        }
        
        .question-item {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .question-text {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #fff;
            text-shadow: 0 1px 5px rgba(0,0,0,0.6);
        }
        
        .question-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .accuracy-bar {
            flex: 1;
            height: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 0 1rem;
        }
        
        .accuracy-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #f39c12, #27ae60);
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        .accuracy-text {
            font-weight: 600;
            color: #fff;
            text-shadow: 0 1px 5px rgba(0,0,0,0.6);
        }
        
        .advanced-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }
        
        .game-info-card {
            background: rgba(59, 130, 246, 0.2);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
            backdrop-filter: blur(20px);
        }
        
        .back-btn {
            position: fixed;
            top: 2rem;
            left: 2rem;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 15px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 1000;
        }
        
        .back-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .game-selector {
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .game-select {
            padding: 1rem 1.5rem;
            border-radius: 20px;
            border: 2px solid rgba(148, 163, 184, 0.3);
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px);
            color: #f1f5f9;
            font-size: 1rem;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
            width: 100%;
            max-width: 500px;
            cursor: pointer;
            transition: all 0.4s ease;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 5"><path fill="%23f1f5f9" d="M2 0L0 2h4zm0 5L0 3h4z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 12px;
            padding-right: 3rem;
        }
        
        .game-select:hover {
            background: rgba(51, 65, 85, 0.9);
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-2px);
        }
        
        .game-select option {
            background: rgba(30, 41, 59, 0.95);
            color: #f1f5f9;
            padding: 0.8rem 1rem;
            border: none;
            border-radius: 8px;
            margin: 2px 0;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .game-select option:hover {
            background: rgba(59, 130, 246, 0.8);
            color: #fff;
        }
        
        .game-select option:checked {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: #fff;
            font-weight: 600;
        }
        
        .export-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 15px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0 0.5rem;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }
        
        .top-performers, .difficulty-analysis {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .performer-item, .difficulty-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .performer-item:hover, .difficulty-item:hover {
            background: rgba(255,255,255,0.15);
            transform: translateX(5px);
        }
        
        .performer-rank {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-right: 1rem;
        }
        
        .rank-1 { background: linear-gradient(135deg, #ffd700, #ffed4e); color: #000; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4); }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0, #e5e5e5); color: #000; box-shadow: 0 4px 15px rgba(192, 192, 192, 0.4); }
        .rank-3 { background: linear-gradient(135deg, #cd7f32, #d4a574); color: #fff; box-shadow: 0 4px 15px rgba(205, 127, 50, 0.4); }
        .rank-other { background: linear-gradient(135deg, #3b82f6, #60a5fa); color: #fff; }
        
        .difficulty-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .difficulty-easy { background: #22c55e; }
        .difficulty-medium { background: #f59e0b; }
        .difficulty-hard { background: #ef4444; }
        .difficulty-very-hard { background: #dc2626; }
        
        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        @media (max-width: 768px) {
            .charts-section { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .advanced-stats { grid-template-columns: 1fr; }
            .title { font-size: 2rem; }
            .container { padding: 0 1rem; }
        }
    </style>
</head>
<body>
    <a href="/" class="back-btn">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
    
    <div class="container">
        <div class="header">
            <div class="title">üìä Game Analytics</div>
            <div class="subtitle">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏Å‡∏°</div>
            <div class="game-selector" style="margin-top: 2rem;">
                <select id="gameSelect" class="game-select">
                    <option value="all">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Å‡∏°</option>
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞...</option>
                </select>
            </div>
            <div style="margin-top: 1rem;">
                <button class="export-btn" onclick="exportAnalytics()">üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å JSON</button>
                <button class="export-btn" onclick="exportPDF()">üìÑ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PDF</button>
                <button class="export-btn" onclick="refreshData()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalGames">-</div>
                <div class="stat-label">üéÆ ‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalPlayers">-</div>
                <div class="stat-label">üë• ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgAccuracy">-</div>
                <div class="stat-label">üéØ ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgTime">-</div>
                <div class="stat-label">‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
            </div>
        </div>
        
        <div class="charts-section">
            <div class="chart-card">
                <div class="chart-title">üìà ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</div>
                <canvas id="accuracyChart"></canvas>
            </div>
            <div class="chart-card">
                <div class="chart-title">üç© ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                <canvas id="scoreChart"></canvas>
            </div>
        </div>
        
        <div class="questions-analysis">
            <div class="chart-title" id="analysisTitle">üìù ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡πâ‡∏≠</div>
            <div id="gameDetails" class="game-details">
                <div class="game-info-card" id="gameInfo" style="display: none;"></div>
                <div class="questions-container" id="questionsList"></div>
            </div>
        </div>
        
        <div class="advanced-stats">
            <div class="chart-card">
                <div class="chart-title">üèÜ ‡∏ô‡∏±‡∏Å‡πÄ‡∏•‡πà‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°</div>
                <div id="topPerformers" class="top-performers"></div>
            </div>
            <div class="chart-card">
                <div class="chart-title">üé≤ ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å</div>
                <div id="difficultyAnalysis" class="difficulty-analysis"></div>
            </div>
        </div>
    </div>

    <script>
        let analyticsData = {};
        let accuracyChart = null;
        let scoreChart = null;
        
        async function loadAnalyticsData() {
            try {
                showLoading(true);
                
                // Check if we have admin token
                const adminToken = sessionStorage.getItem('adminToken');
                if (!adminToken) {
                    window.location.href = '/analytics-login';
                    return;
                }
                
                const headers = { 'X-Admin-Token': adminToken };
                const [analyticsResponse, gamesResponse] = await Promise.all([
                    fetch('/api/analytics-data', { headers }),
                    fetch('/api/games-list', { headers })
                ]);
                
                if (analyticsResponse.status === 401 || gamesResponse.status === 401) {
                    sessionStorage.removeItem('adminToken');
                    window.location.href = '/analytics-login';
                    return;
                }
                
                analyticsData = await analyticsResponse.json();
                const gamesList = await gamesResponse.json();
                
                loadGamesList(gamesList);
                
                showLoading(false);
            } catch (error) {
                console.error('Error loading analytics:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                showLoading(false);
            }
        }
        
        function loadGamesList(games) {
            const gameSelect = document.getElementById('gameSelect');
            gameSelect.innerHTML = `
                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡∏°...</option>
            `;
            
            games.forEach(game => {
                const option = document.createElement('option');
                option.value = game.pin;
                const date = new Date(game.finished_at).toLocaleString('th-TH');
                option.textContent = `PIN: ${game.pin} - ${game.host_name} (${game.total_players} ‡∏Ñ‡∏ô) - ${date}`;
                gameSelect.appendChild(option);
            });
            
            // Auto-select first game if available
            if (games.length > 0) {
                gameSelect.value = games[0].pin;
                loadGameDetails(games[0].pin);
            }
            
            gameSelect.onchange = function() {
                if (this.value) {
                    loadGameDetails(this.value);
                }
            };
        }
        
        async function loadGameDetails(pin) {
            try {
                showLoading(true);
                const adminToken = sessionStorage.getItem('adminToken');
                const response = await fetch(`/api/game-analytics/${pin}`, {
                    headers: { 'X-Admin-Token': adminToken }
                });
                const data = await response.json();
                
                if (data.error) {
                    showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏°: ' + data.error, 'error');
                    return;
                }
                
                await displayGameDetails(data);
                showLoading(false);
            } catch (error) {
                console.error('Error loading game details:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
                showLoading(false);
            }
        }
        
        async function loadGameAverageTime(pin) {
            try {
                const adminToken = sessionStorage.getItem('adminToken');
                const response = await fetch(`/api/game-average-time/${pin}`, {
                    headers: { 'X-Admin-Token': adminToken }
                });
                const data = await response.json();
                
                if (data.avg_time !== undefined) {
                    document.getElementById('avgTime').textContent = Math.round(data.avg_time) + 's';
                } else {
                    document.getElementById('avgTime').textContent = '-';
                }
            } catch (error) {
                console.error('Error loading average time:', error);
                document.getElementById('avgTime').textContent = '-';
            }
        }
        
        async function updateTopPerformersForGame(data) {
            const container = document.getElementById('topPerformers');
            
            try {
                const adminToken = sessionStorage.getItem('adminToken');
                const response = await fetch(`/api/game-top-players/${data.game_info.pin}`, {
                    headers: { 'X-Admin-Token': adminToken }
                });
                const playersData = await response.json();
                
                if (!playersData.players || playersData.players.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; opacity: 0.7;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
                    return;
                }
                
                container.innerHTML = playersData.players.map((player, index) => {
                    const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : 'rank-other';
                    const accuracy = player.total_answers > 0 ? Math.round((player.correct_answers / player.total_answers) * 100) : 0;
                    const finalScore = player.final_score || 0;
                    return `
                        <div class="performer-item">
                            <div style="display: flex; align-items: center;">
                                <div class="performer-rank ${rankClass}">${index + 1}</div>
                                <div style="font-weight: 600; color: #fff;">${player.player_name}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1rem; font-weight: 700; color: ${index === 0 ? '#ffd700' : index === 1 ? '#c0c0c0' : index === 2 ? '#cd7f32' : '#60a5fa'};">${player.correct_answers}/${player.total_answers} | ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ${finalScore}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading top players:', error);
                container.innerHTML = '<div style="text-align: center; padding: 2rem; opacity: 0.7;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>';
            }
        }
        
        function updateDifficultyAnalysisForGame(data) {
            const container = document.getElementById('difficultyAnalysis');
            const questionStats = Object.values(data.question_stats);
            
            if (questionStats.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; opacity: 0.7;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
                return;
            }
            
            const difficultyClasses = {
                '‡∏á‡πà‡∏≤‡∏¢': 'difficulty-easy',
                '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á': 'difficulty-medium', 
                '‡∏¢‡∏≤‡∏Å': 'difficulty-hard',
                '‡∏¢‡∏≤‡∏Å‡∏°‡∏≤‡∏Å': 'difficulty-very-hard'
            };
            
            const analysis = Object.keys(data.question_stats).sort((a,b) => parseInt(a) - parseInt(b)).map(qNum => {
                const q = data.question_stats[qNum];
                const total = Object.values(q.answers).reduce((sum, count) => sum + count, 0);
                const correctCount = q.answers[q.correct_answer] || 0;
                const accuracy = total > 0 ? Math.round((correctCount / total) * 100) : 0;
                
                let difficulty;
                if (accuracy >= 80) difficulty = '‡∏á‡πà‡∏≤‡∏¢';
                else if (accuracy >= 60) difficulty = '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á';
                else if (accuracy >= 40) difficulty = '‡∏¢‡∏≤‡∏Å';
                else difficulty = '‡∏¢‡∏≤‡∏Å‡∏°‡∏≤‡∏Å';
                
                return {
                    question_number: qNum,
                    accuracy: accuracy,
                    difficulty: difficulty
                };
            }).sort((a, b) => a.accuracy - b.accuracy);
            
            container.innerHTML = analysis.map(q => `
                <div class="difficulty-item">
                    <div>
                        <div style="font-weight: 600; color: #fff;">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠ ${q.question_number}</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">${q.accuracy}% ‡∏ñ‡∏π‡∏Å</div>
                    </div>
                    <div class="difficulty-badge ${difficultyClasses[q.difficulty] || 'difficulty-medium'}">${q.difficulty}</div>
                </div>
            `).join('');
        }
        
        async function displayGameDetails(data) {
            // Update stats for specific game
            document.getElementById('totalGames').textContent = '1';
            document.getElementById('totalPlayers').textContent = data.game_info.total_players;
            
            const questionStats = Object.values(data.question_stats);
            let totalAnswers = 0, correctAnswers = 0;
            questionStats.forEach(q => {
                const total = Object.values(q.answers).reduce((sum, count) => sum + count, 0);
                const correct = q.answers[q.correct_answer] || 0;
                totalAnswers += total;
                correctAnswers += correct;
            });
            const accuracy = totalAnswers > 0 ? Math.round((correctAnswers / totalAnswers) * 100) : 0;
            document.getElementById('avgAccuracy').textContent = accuracy + '%';
            
            // Calculate average time for this specific game
            loadGameAverageTime(data.game_info.pin);
            
            // Update charts for specific game
            updateChartsForGame(data);
            
            // Update question stats
            updateQuestionStatsForGame(data);
            
            // Update sections for game-specific view
            await updateTopPerformersForGame(data);
            updateDifficultyAnalysisForGame(data);
        }
        
        function updateChartsForGame(data) {
            if (accuracyChart) accuracyChart.destroy();
            if (scoreChart) scoreChart.destroy();
            
            const questionStats = Object.values(data.question_stats);
            const accuracyData = questionStats.map(q => {
                const total = Object.values(q.answers).reduce((sum, count) => sum + count, 0);
                const correctCount = q.answers[q.correct_answer] || 0;
                return total > 0 ? Math.round((correctCount / total) * 100) : 0;
            });
            const questionLabels = Object.keys(data.question_stats).sort((a,b) => parseInt(a) - parseInt(b)).map(q => `Q${q}`);
            
            // Accuracy chart
            const accuracyCtx = document.getElementById('accuracyChart').getContext('2d');
            accuracyChart = new Chart(accuracyCtx, {
                type: 'bar',
                data: {
                    labels: questionLabels,
                    datasets: [{
                        label: '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ (%)',
                        data: accuracyData,
                        backgroundColor: accuracyData.map(acc => 
                            acc >= 80 ? '#22c55e' : acc >= 60 ? '#f59e0b' : acc >= 40 ? '#ef4444' : '#dc2626'
                        ),
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { 
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            color: '#fff',
                            font: { weight: 'bold' },
                            formatter: (value) => value + '%'
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, max: 100, ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.2)' } },
                        x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.2)' } }
                    }
                }
            });
            
            // Answer distribution chart
            const answerCounts = {'A': 0, 'B': 0, 'C': 0, 'D': 0};
            questionStats.forEach(q => {
                Object.keys(q.answers).forEach(letter => {
                    answerCounts[letter] += q.answers[letter];
                });
            });
            
            const scoreCtx = document.getElementById('scoreChart').getContext('2d');
            scoreChart = new Chart(scoreCtx, {
                type: 'doughnut',
                data: {
                    labels: ['A', 'B', 'C', 'D'],
                    datasets: [{
                        data: [answerCounts.A, answerCounts.B, answerCounts.C, answerCounts.D],
                        backgroundColor: ['#e74c3c', '#f39c12', '#f1c40f', '#27ae60'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { 
                        legend: { position: 'bottom', labels: { color: '#fff' } },
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold', size: 14 },
                            formatter: (value, context) => {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return percentage + '%';
                            }
                        }
                    }
                }
            });
        }
        
        function updateQuestionStatsForGame(data) {
            const container = document.getElementById('questionsList');
            
            container.innerHTML = Object.keys(data.question_stats).sort((a,b) => parseInt(a) - parseInt(b)).map(qNum => {
                const q = data.question_stats[qNum];
                const total = Object.values(q.answers).reduce((sum, count) => sum + count, 0);
                const correctCount = q.answers[q.correct_answer] || 0;
                const accuracy = total > 0 ? Math.round((correctCount / total) * 100) : 0;
                
                return `
                    <div class="question-item">
                        <div class="question-text">Q${qNum}: ${q.question}</div>
                        <div class="question-stats">
                            <span class="accuracy-text">${correctCount}/${total}</span>
                            <div class="accuracy-bar">
                                <div class="accuracy-fill" style="width: ${accuracy}%"></div>
                            </div>
                            <span class="accuracy-text">${accuracy}%</span>
                        </div>
                        <div style="margin-top: 1rem; font-size: 0.9rem; text-align: center; opacity: 0.9;">
                            ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å: <span style="color: #22c55e; font-weight: 600;">${q.correct_answer}</span> | 
                            ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å: ${accuracy >= 80 ? '‡∏á‡πà‡∏≤‡∏¢' : accuracy >= 60 ? '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' : accuracy >= 40 ? '‡∏¢‡∏≤‡∏Å' : '‡∏¢‡∏≤‡∏Å‡∏°‡∏≤‡∏Å'}
                        </div>
                        <div style="margin-top: 1.5rem;">
                            <div style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; text-align: center; color: #cbd5e1;">üìä ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</div>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.8rem;">
                                ${['A', 'B', 'C', 'D'].map(letter => {
                                    const count = q.answers[letter] || 0;
                                    const percentage = total > 0 ? Math.round((count / total) * 100) : 0;
                                    const isCorrect = letter === q.correct_answer;
                                    return `
                                        <div style="text-align: center; padding: 1rem; background: ${isCorrect ? 'rgba(34, 197, 94, 0.3)' : 'rgba(255,255,255,0.1)'}; border-radius: 12px; border: ${isCorrect ? '3px solid #22c55e' : '2px solid rgba(255,255,255,0.2)'}; transition: all 0.3s ease; position: relative; ${isCorrect ? 'box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);' : ''}">
                                            ${isCorrect ? '<div style="position: absolute; top: -8px; right: -8px; background: #22c55e; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700;">‚úì</div>' : ''}
                                            <div style="font-weight: 800; font-size: 1.3rem; margin-bottom: 0.5rem; color: ${isCorrect ? '#22c55e' : '#fff'};">${letter}</div>
                                            <div style="font-size: 1.1rem; font-weight: 700; color: #fff; margin-bottom: 0.2rem;">${count} ‡∏Ñ‡∏ô</div>
                                            <div style="font-size: 1rem; font-weight: 600; color: ${isCorrect ? '#22c55e' : '#60a5fa'}; background: rgba(0,0,0,0.2); padding: 0.2rem 0.5rem; border-radius: 8px;">${percentage}%</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateUI() {
            document.getElementById('totalGames').textContent = analyticsData.total_games || 0;
            document.getElementById('totalPlayers').textContent = analyticsData.total_players || 0;
            document.getElementById('avgAccuracy').textContent = Math.round(analyticsData.avg_accuracy || 0) + '%';
            document.getElementById('avgTime').textContent = Math.round(analyticsData.avg_time || 0) + 's';
        }
        
        function updateCharts() {
            // Destroy existing charts
            if (accuracyChart) accuracyChart.destroy();
            if (scoreChart) scoreChart.destroy();
            
            // Accuracy Chart
            const questionStats = analyticsData.question_stats || [];
            const accuracyData = questionStats.map(q => Math.round(q.accuracy || 0));
            const questionLabels = questionStats.map(q => `Q${q.question_number}`);
            
            const accuracyCtx = document.getElementById('accuracyChart').getContext('2d');
            accuracyChart = new Chart(accuracyCtx, {
                type: 'bar',
                data: {
                    labels: questionLabels.length > 0 ? questionLabels : ['‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'],
                    datasets: [{
                        label: '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ (%)',
                        data: accuracyData.length > 0 ? accuracyData : [0],
                        backgroundColor: questionLabels.map((_, i) => {
                            const accuracy = accuracyData[i] || 0;
                            if (accuracy >= 80) return '#22c55e';
                            if (accuracy >= 60) return '#f59e0b';
                            if (accuracy >= 40) return '#ef4444';
                            return '#dc2626';
                        }),
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255,255,255,0.2)' }
                        },
                        x: {
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255,255,255,0.2)' }
                        }
                    }
                }
            });
            
            // Score Distribution Chart
            const scoreDistribution = analyticsData.score_distribution || [];
            const scoreLabels = scoreDistribution.map(s => s.score_range);
            const scoreCounts = scoreDistribution.map(s => s.count);
            
            const scoreCtx = document.getElementById('scoreChart').getContext('2d');
            scoreChart = new Chart(scoreCtx, {
                type: 'doughnut',
                data: {
                    labels: scoreLabels.length > 0 ? scoreLabels : ['‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'],
                    datasets: [{
                        data: scoreCounts.length > 0 ? scoreCounts : [1],
                        backgroundColor: [
                            '#dc2626', '#ef4444', '#f59e0b', 
                            '#22c55e', '#16a34a', '#059669'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#fff' }
                        }
                    }
                }
            });
        }
        
        function updateTopPerformers(performers) {
            const container = document.getElementById('topPerformers');
            if (!performers || performers.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; opacity: 0.7;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
                return;
            }
            
            // Remove duplicates by player name and keep the best score
            const uniquePerformers = [];
            const seenNames = new Map();
            
            for (const player of performers) {
                const existing = seenNames.get(player.player_name);
                if (!existing || (player.best_score || 0) > (existing.best_score || 0)) {
                    seenNames.set(player.player_name, player);
                }
            }
            
            const finalPerformers = Array.from(seenNames.values()).sort((a, b) => (b.best_score || 0) - (a.best_score || 0));
            
            container.innerHTML = finalPerformers.slice(0, 10).map((player, index) => {
                const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : 'rank-other';
                return `
                    <div class="performer-item">
                        <div style="display: flex; align-items: center;">
                            <div class="performer-rank ${rankClass}">${index + 1}</div>
                            <div style="font-weight: 600; color: #fff;">${player.player_name}</div>
                        </div>
                        <div style="font-size: 1.2rem; font-weight: 700; color: #60a5fa;">${player.best_score}</div>
                    </div>
                `;
            }).join('');
        }
        
        function updateDifficultyAnalysis(analysis) {
            const container = document.getElementById('difficultyAnalysis');
            if (!analysis || analysis.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; opacity: 0.7;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
                return;
            }
            
            const difficultyClasses = {
                '‡∏á‡πà‡∏≤‡∏¢': 'difficulty-easy',
                '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á': 'difficulty-medium', 
                '‡∏¢‡∏≤‡∏Å': 'difficulty-hard',
                '‡∏¢‡∏≤‡∏Å‡∏°‡∏≤‡∏Å': 'difficulty-very-hard'
            };
            
            container.innerHTML = analysis.slice(0, 15).map(q => `
                <div class="difficulty-item">
                    <div>
                        <div style="font-weight: 600; color: #fff;">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠ ${q.question_number}</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">${Math.round(q.accuracy)}% ‡∏ñ‡∏π‡∏Å | ${Math.round(q.avg_time)}s ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
                    </div>
                    <div class="difficulty-badge ${difficultyClasses[q.difficulty] || 'difficulty-medium'}">${q.difficulty}</div>
                </div>
            `).join('');
        }
        
        function updateQuestionStats(stats) {
            const container = document.getElementById('questionsList');
            if (!stats || stats.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; opacity: 0.7;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</div>';
                return;
            }
            
            container.innerHTML = stats.map(q => {
                const accuracy = Math.round(q.accuracy || 0);
                
                return `
                    <div class="question-item">
                        <div class="question-text">Q${q.question_number}: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${q.question_number}</div>
                        <div class="question-stats">
                            <span class="accuracy-text">${q.correct_answers}/${q.total_answers}</span>
                            <div class="accuracy-bar">
                                <div class="accuracy-fill" style="width: ${accuracy}%"></div>
                            </div>
                            <span class="accuracy-text">${accuracy}%</span>
                        </div>
                        <div style="font-size: 0.9rem; margin-top: 0.5rem; opacity: 0.8; text-align: center;">
                            ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${Math.round(q.avg_time || 0)}s | 
                            ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å: ${accuracy >= 80 ? '‡∏á‡πà‡∏≤‡∏¢' : accuracy >= 60 ? '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' : accuracy >= 40 ? '‡∏¢‡∏≤‡∏Å' : '‡∏¢‡∏≤‡∏Å‡∏°‡∏≤‡∏Å'}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function exportAnalytics() {
            try {
                const adminToken = sessionStorage.getItem('adminToken');
                const response = await fetch('/api/export-analytics', {
                    headers: { 'X-Admin-Token': adminToken }
                });
                const data = await response.json();
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `analytics-report-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å', 'error');
            }
        }
        
        async function exportPDF() {
            try {
                showLoading(true);
                
                const gameSelect = document.getElementById('gameSelect');
                const isSpecificGame = gameSelect.value !== 'all' && gameSelect.value !== '';
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4',
                    compress: true,
                    putOnlyUsedFonts: true
                });
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÑ‡∏ó‡∏¢
                // Using system fonts for PDF
                pdf.setFont('Sarabun');
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà 1 - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å
                await addMainPageImproved(pdf, isSpecificGame, gameSelect);
                
    
                
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0];
                const gameInfo = isSpecificGame ? `-PIN-${gameSelect.value}` : '-All-Games';
                const fileName = `Modern-Quiz-Analytics${gameInfo}-${timestamp}.pdf`;
                pdf.save(fileName);
                
                showLoading(false);
                showNotification('üìÑ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PDF ‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!', 'success');
                
            } catch (error) {
                console.error('PDF Export error:', error);
                showLoading(false);
                showNotification('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PDF: ' + error.message, 'error');
            }
        }
        
        async function addMainPageImproved(pdf, isSpecificGame, gameSelect) {
            await addSummaryPage(pdf, isSpecificGame, gameSelect);
            
            pdf.addPage();
            await addChartsPageImproved(pdf);
            
            pdf.addPage();
            await addPerformersPage(pdf);
            
            const questions = document.querySelectorAll('#questionsList .question-item');
            if (questions.length > 0) {
                // ‡πÅ‡∏ö‡πà‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏´‡∏ô‡πâ‡∏≤
                const questionsPerPage = Math.ceil(questions.length / 2);
                
                // ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
                pdf.addPage();
                await addQuestionsPage(pdf, 0, questionsPerPage);
                
                // ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏∑‡∏≠)
                if (questions.length > questionsPerPage) {
                    pdf.addPage();
                    await addQuestionsPage(pdf, 1, questionsPerPage);
                }
            }
        }
        
        async function addSummaryPage(pdf, isSpecificGame, gameSelect) {
            const pageElement = document.createElement('div');
            pageElement.style.cssText = `
                width: 210mm; height: 297mm; padding: 20mm; background: white; color: black;
                font-family: 'Noto Sans Thai', 'Roboto', sans-serif; position: absolute; top: -9999px;
                box-sizing: border-box; font-size: 14px; line-height: 1.4;
            `;
            
            const currentDate = new Date().toLocaleString('th-TH');
            
            pageElement.innerHTML = `
                <!-- Header -->
                <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px;">
                    <h1 style="font-size: 24px; margin: 0 0 10px 0; color: #333;">üìä Modern Quiz Analytics Report</h1>
                    <p style="font-size: 12px; margin: 0; color: #666;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${currentDate}</p>
                    ${isSpecificGame ? `<p style="font-size: 11px; margin: 5px 0 0 0; color: #e74c3c; font-weight: bold;">${gameSelect.options[gameSelect.selectedIndex].text}</p>` : ''}
                </div>
                
                <!-- ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏Å -->
                <div style="margin-bottom: 40px;">
                    <h2 style="font-size: 18px; margin: 0 0 20px 0; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 5px;">üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏ß‡∏°</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div style="border: 1px solid #ddd; padding: 15px; border-radius: 5px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #3498db; margin-bottom: 5px;">${document.getElementById('totalGames').textContent}</div>
                            <div style="font-size: 12px; color: #666;">üéÆ ‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        </div>
                        <div style="border: 1px solid #ddd; padding: 15px; border-radius: 5px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #e74c3c; margin-bottom: 5px;">${document.getElementById('totalPlayers').textContent}</div>
                            <div style="font-size: 12px; color: #666;">üë• ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        </div>
                        <div style="border: 1px solid #ddd; padding: 15px; border-radius: 5px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #27ae60; margin-bottom: 5px;">${document.getElementById('avgAccuracy').textContent}</div>
                            <div style="font-size: 12px; color: #666;">üéØ ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
                        </div>
                        <div style="border: 1px solid #ddd; padding: 15px; border-radius: 5px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #f39c12; margin-bottom: 5px;">${document.getElementById('avgTime').textContent}</div>
                            <div style="font-size: 12px; color: #666;">‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏≠‡∏ö‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
                        </div>
                    </div>
                </div>
                
                <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
                <div style="margin-bottom: 30px;">
                    <h2 style="font-size: 18px; margin: 0 0 15px 0; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 5px;">üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</h2>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #3498db;">
                        <p style="margin: 0 0 10px 0; font-size: 13px;">‚Ä¢ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏Å‡∏° Modern Quiz</p>
                        <p style="margin: 0 0 10px 0; font-size: 13px;">‚Ä¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ß‡∏°‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                        <p style="margin: 0; font-size: 13px;">‚Ä¢ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡∏°</p>
                    </div>
                </div>
                
                <!-- Footer -->
                <div style="position: absolute; bottom: 20mm; left: 20mm; right: 20mm; text-align: center; font-size: 10px; color: #999; border-top: 1px solid #ddd; padding-top: 10px;">
                    <p style="margin: 0;">Modern Quiz Analytics System ‚Ä¢ ‡∏´‡∏ô‡πâ‡∏≤ 1</p>
                </div>
            `;
            
            document.body.appendChild(pageElement);
            
            const canvas = await html2canvas(pageElement, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff',
                width: pageElement.offsetWidth,
                height: pageElement.offsetHeight
            });
            
            const imgData = canvas.toDataURL('image/png', 0.9);
            pdf.addImage(imgData, 'PNG', 0, 0, 210, 297);
            
            document.body.removeChild(pageElement);
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤ - ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß
        async function addMainPage(pdf, isSpecificGame, gameSelect) {
            const reportElement = document.createElement('div');
            reportElement.style.cssText = `
                width: 1200px; padding: 30px; background: white; color: black;
                font-family: 'Noto Sans Thai', 'Roboto', sans-serif; position: absolute; top: -9999px;
                box-sizing: border-box; line-height: 1.4; min-height: 1600px;
            `;
            
            reportElement.innerHTML = `
                <!-- ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô -->
                <div style="text-align: center; margin-bottom: 30px; border-bottom: 4px solid #3498db; padding-bottom: 20px;">
                    <h1 style="color: #2c3e50; font-size: 36px; margin: 0; font-weight: 800;">üìä Game Analytics Report</h1>
                    <p style="color: #7f8c8d; font-size: 16px; margin: 10px 0 5px 0;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date().toLocaleString('th-TH')}</p>
                    ${isSpecificGame ? `<p style="color: #e74c3c; font-size: 14px; margin: 5px 0 0 0; font-weight: 600;">${gameSelect.options[gameSelect.selectedIndex].text}</p>` : ''}
                </div>
                
                <!-- ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏Å -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px;">
                    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #3498db, #2980b9); color: white; border-radius: 15px;">
                        <div style="font-size: 32px; font-weight: 800; margin-bottom: 8px;">${document.getElementById('totalGames').textContent}</div>
                        <div style="font-size: 14px; font-weight: 600;">üéÆ ‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; border-radius: 15px;">
                        <div style="font-size: 32px; font-weight: 800; margin-bottom: 8px;">${document.getElementById('totalPlayers').textContent}</div>
                        <div style="font-size: 14px; font-weight: 600;">üë• ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #27ae60, #229954); color: white; border-radius: 15px;">
                        <div style="font-size: 32px; font-weight: 800; margin-bottom: 8px;">${document.getElementById('avgAccuracy').textContent}</div>
                        <div style="font-size: 14px; font-weight: 600;">üéØ ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #f39c12, #e67e22); color: white; border-radius: 15px;">
                        <div style="font-size: 32px; font-weight: 800; margin-bottom: 8px;">${document.getElementById('avgTime').textContent}</div>
                        <div style="font-size: 14px; font-weight: 600;">‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
                    </div>
                </div>
                
                <!-- ‡∏ô‡∏±‡∏Å‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; border: 2px solid #dee2e6;">
                        <h3 style="color: #2c3e50; margin: 0 0 15px 0; font-size: 18px; text-align: center; font-weight: 700;">üèÜ ‡∏ô‡∏±‡∏Å‡πÄ‡∏•‡πà‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°</h3>
                        ${getCompactPerformersHTML()}
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; border: 2px solid #dee2e6;">
                        <h3 style="color: #2c3e50; margin: 0 0 15px 0; font-size: 18px; text-align: center; font-weight: 700;">üé≤ ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å</h3>
                        ${getCompactDifficultyHTML()}
                    </div>
                </div>
                
                <!-- ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; border: 2px solid #dee2e6; margin-bottom: 20px;">
                    <h3 style="color: #2c3e50; margin: 0 0 15px 0; font-size: 18px; text-align: center; font-weight: 700;">üìù ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                    ${getCompactQuestionsHTML()}
                </div>
                
                <!-- Footer -->
                <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 2px solid #bdc3c7; color: #7f8c8d; font-size: 14px;">
                    <p style="margin: 0;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö Quiz Analytics ‚Ä¢ ${new Date().toLocaleString('th-TH')}</p>
                </div>
            `;
            
            document.body.appendChild(reportElement);
            
            const canvas = await html2canvas(reportElement, {
                scale: 2,
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff',
                width: reportElement.offsetWidth,
                height: reportElement.offsetHeight
            });
            
            const imgData = canvas.toDataURL('image/png', 1.0);
            const imgWidth = 210;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            
            pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
            
            document.body.removeChild(reportElement);
        }
        
        async function addChartsPageImproved(pdf) {
            const pageElement = document.createElement('div');
            pageElement.style.cssText = `
                width: 210mm; height: 297mm; padding: 20mm; background: white; color: black;
                font-family: 'Noto Sans Thai', 'Roboto', sans-serif; position: absolute; top: -9999px;
                box-sizing: border-box; font-size: 14px; line-height: 1.4;
            `;
            
            pageElement.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px;">
                    <h1 style="font-size: 24px; margin: 0 0 10px 0; color: #333;">üìä ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏†‡∏π‡∏°‡∏¥</h1>
                    <p style="font-size: 12px; margin: 0; color: #666;">‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å</p>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <div style="border: 1px solid #ddd; padding: 20px; border-radius: 5px; text-align: center; margin-bottom: 30px;">
                        <h3 style="font-size: 16px; margin: 0 0 20px 0; color: #333;">üìà ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</h3>
                        <canvas id="pdfAccuracyChart" width="600" height="200"></canvas>
                        <p style="margin: 15px 0 0 0; font-size: 12px; color: #666; line-height: 1.4;">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≥‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß</p>
                    </div>
                    <div style="border: 1px solid #ddd; padding: 20px; border-radius: 5px; text-align: center;">
                        <h3 style="font-size: 16px; margin: 0 0 20px 0; color: #333;">üç© ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</h3>
                        <div style="display: flex; justify-content: center; margin-bottom: 15px;">
                            <canvas id="pdfScoreChart" width="300" height="200"></canvas>
                        </div>
                        <p style="margin: 0; font-size: 12px; color: #666; line-height: 1.4;">‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö A, B, C, D ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡πÅ‡∏•‡∏∞‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</p>
                    </div>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h2 style="font-size: 18px; margin: 0 0 15px 0; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 5px;">üìã ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏£‡∏≤‡∏ü</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #3498db;">
                            <h4 style="font-size: 14px; margin: 0 0 10px 0; color: #3498db;">üìà ‡∏Å‡∏£‡∏≤‡∏ü‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥</h4>
                            <p style="margin: 0; font-size: 12px; line-height: 1.5;">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡∏ä‡πà‡∏ß‡∏¢‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏¢‡∏≤‡∏Å‡πÅ‡∏•‡∏∞‡∏á‡πà‡∏≤‡∏¢</p>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #e74c3c;">
                            <h4 style="font-size: 14px; margin: 0 0 10px 0; color: #e74c3c;">üç© ‡∏Å‡∏£‡∏≤‡∏ü‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢</h4>
                            <p style="margin: 0; font-size: 12px; line-height: 1.5;">‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö</p>
                        </div>
                    </div>
                </div>
                
                <div style="position: absolute; bottom: 20mm; left: 20mm; right: 20mm; text-align: center; font-size: 10px; color: #999; border-top: 1px solid #ddd; padding-top: 10px;">
                    <p style="margin: 0;">Modern Quiz Analytics System ‚Ä¢ ‡∏´‡∏ô‡πâ‡∏≤ 2</p>
                </div>
            `;
            
            document.body.appendChild(pageElement);
            
            await createPDFChartsImproved();
            
            const canvas = await html2canvas(pageElement, {
                scale: 3,
                useCORS: true,
                backgroundColor: '#ffffff',
                width: pageElement.offsetWidth,
                height: pageElement.offsetHeight
            });
            
            const imgData = canvas.toDataURL('image/png', 1.0);
            pdf.addImage(imgData, 'PNG', 0, 0, 210, 297);
            
            document.body.removeChild(pageElement);
        }
        
        async function addPerformersPage(pdf) {
            const pageElement = document.createElement('div');
            pageElement.style.cssText = `
                width: 210mm; height: 297mm; padding: 20mm; background: white; color: black;
                font-family: 'Noto Sans Thai', 'Roboto', sans-serif; position: absolute; top: -9999px;
                box-sizing: border-box; font-size: 14px; line-height: 1.4;
            `;
            
            pageElement.innerHTML = `
                <!-- Header -->
                <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px;">
                    <h1 style="font-size: 24px; margin: 0 0 10px 0; color: #333;">üèÜ ‡∏ô‡∏±‡∏Å‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h1>
                    <p style="font-size: 12px; margin: 0; color: #666;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å</p>
                </div>
                
                <!-- Content -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px;">
                    <div>
                        <h2 style="font-size: 18px; margin: 0 0 15px 0; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 5px;">üèÜ ‡∏ô‡∏±‡∏Å‡πÄ‡∏•‡πà‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°</h2>
                        ${getTopPerformersForPDF()}
                    </div>
                    <div>
                        <h2 style="font-size: 18px; margin: 0 0 15px 0; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 5px;">üé≤ ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å</h2>
                        ${getDifficultyForPDF()}
                    </div>
                </div>
                
                <!-- Footer -->
                <div style="position: absolute; bottom: 20mm; left: 20mm; right: 20mm; text-align: center; font-size: 10px; color: #999; border-top: 1px solid #ddd; padding-top: 10px;">
                    <p style="margin: 0;">Modern Quiz Analytics System ‚Ä¢ ‡∏´‡∏ô‡πâ‡∏≤ 3</p>
                </div>
            `;
            
            document.body.appendChild(pageElement);
            
            const canvas = await html2canvas(pageElement, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff',
                width: pageElement.offsetWidth,
                height: pageElement.offsetHeight
            });
            
            const imgData = canvas.toDataURL('image/png', 0.9);
            pdf.addImage(imgData, 'PNG', 0, 0, 210, 297);
            
            document.body.removeChild(pageElement);
        }
        
        async function addQuestionsPage(pdf, pageIndex = 0, questionsPerPage = 6) {
            const pageElement = document.createElement('div');
            pageElement.style.cssText = `
                width: 210mm; height: 297mm; padding: 20mm; background: white; color: black;
                font-family: 'Noto Sans Thai', 'Roboto', sans-serif; position: absolute; top: -9999px;
                box-sizing: border-box; font-size: 14px; line-height: 1.4;
            `;
            
            const totalQuestions = document.querySelectorAll('#questionsList .question-item').length;
            const actualQuestionsPerPage = Math.ceil(totalQuestions / 2);
            const startIndex = pageIndex * actualQuestionsPerPage;
            const endIndex = Math.min(startIndex + actualQuestionsPerPage, totalQuestions);
            const currentPageNum = pageIndex + 4; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ 4
            
            pageElement.innerHTML = `
                <!-- Header -->
                <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px;">
                    <h1 style="font-size: 24px; margin: 0 0 10px 0; color: #333;">üìù ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</h1>
                    <p style="font-size: 12px; margin: 0; color: #666;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (‡∏Ç‡πâ‡∏≠ ${startIndex + 1}-${endIndex} ‡∏à‡∏≤‡∏Å ${totalQuestions} ‡∏Ç‡πâ‡∏≠)</p>
                </div>
                
                <!-- Questions -->
                <div style="margin-bottom: 40px;">
                    ${getQuestionsForPDF(startIndex, endIndex)}
                </div>
                
                <!-- Footer -->
                <div style="position: absolute; bottom: 20mm; left: 20mm; right: 20mm; text-align: center; font-size: 10px; color: #999; border-top: 1px solid #ddd; padding-top: 10px;">
                    <p style="margin: 0;">Modern Quiz Analytics System ‚Ä¢ ‡∏´‡∏ô‡πâ‡∏≤ ${currentPageNum}</p>
                </div>
            `;
            
            document.body.appendChild(pageElement);
            
            const canvas = await html2canvas(pageElement, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff',
                width: pageElement.offsetWidth,
                height: pageElement.offsetHeight
            });
            
            const imgData = canvas.toDataURL('image/png', 0.9);
            pdf.addImage(imgData, 'PNG', 0, 0, 210, 297);
            
            document.body.removeChild(pageElement);
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤ - ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß
        async function addChartsPage(pdf) {
            const chartsElement = document.createElement('div');
            chartsElement.style.cssText = `
                width: 1200px; padding: 30px; background: white; color: black;
                font-family: 'Noto Sans Thai', 'Roboto', sans-serif; position: absolute; top: -9999px;
                box-sizing: border-box; line-height: 1.4; min-height: 1600px;
            `;
            
            chartsElement.innerHTML = `
                <!-- ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏≤‡∏ü -->
                <div style="text-align: center; margin-bottom: 40px; border-bottom: 4px solid #e74c3c; padding-bottom: 20px;">
                    <h1 style="color: #2c3e50; font-size: 36px; margin: 0; font-weight: 800;">üìà Charts & Graphs</h1>
                    <p style="color: #7f8c8d; font-size: 16px; margin: 10px 0 0 0;">‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏†‡∏π‡∏°‡∏¥‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                </div>
                
                <!-- ‡∏Å‡∏£‡∏≤‡∏ü -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px;">
                    <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; border: 2px solid #dee2e6; text-align: center;">
                        <h3 style="color: #2c3e50; margin: 0 0 20px 0; font-size: 20px; font-weight: 700;">üìä ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</h3>
                        <canvas id="pdfAccuracyChart" width="400" height="300"></canvas>
                    </div>
                    <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; border: 2px solid #dee2e6; text-align: center;">
                        <h3 style="color: #2c3e50; margin: 0 0 20px 0; font-size: 20px; font-weight: 700;">üç© ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
                        <canvas id="pdfScoreChart" width="400" height="300"></canvas>
                    </div>
                </div>
                
                <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° -->
                <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; border: 2px solid #dee2e6; margin-bottom: 30px;">
                    <h3 style="color: #2c3e50; margin: 0 0 20px 0; font-size: 20px; text-align: center; font-weight: 700;">üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏≤‡∏ü</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 14px;">
                        <div>
                            <h4 style="color: #3498db; margin: 0 0 10px 0;">üìà ‡∏Å‡∏£‡∏≤‡∏ü‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥:</h4>
                            <p style="margin: 0; line-height: 1.6; color: #2c3e50;">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡∏ä‡πà‡∏ß‡∏¢‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏¢‡∏≤‡∏Å‡πÅ‡∏•‡∏∞‡∏á‡πà‡∏≤‡∏¢</p>
                        </div>
                        <div>
                            <h4 style="color: #e74c3c; margin: 0 0 10px 0;">üç© ‡∏Å‡∏£‡∏≤‡∏ü‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢:</h4>
                            <p style="margin: 0; line-height: 1.6; color: #2c3e50;">‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö</p>
                        </div>
                    </div>
                </div>
                
                <!-- Footer -->
                <div style="text-align: center; margin-top: 30px; padding-top: 15px; border-top: 2px solid #bdc3c7; color: #7f8c8d; font-size: 14px;">
                    <p style="margin: 0;">‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà 2 - ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏†‡∏π‡∏°‡∏¥ ‚Ä¢ ${new Date().toLocaleString('th-TH')}</p>
                </div>
            `;
            
            document.body.appendChild(chartsElement);
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏ô canvas ‡πÉ‡∏´‡∏°‡πà
            await createPDFCharts();
            
            const canvas = await html2canvas(chartsElement, {
                scale: 2,
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff',
                width: chartsElement.offsetWidth,
                height: chartsElement.offsetHeight
            });
            
            const imgData = canvas.toDataURL('image/png', 1.0);
            const imgWidth = 210;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            
            pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
            
            document.body.removeChild(chartsElement);
        }
        
        async function createPDFChartsImproved() {
            const accuracyCanvas = document.getElementById('pdfAccuracyChart');
            const scoreCanvas = document.getElementById('pdfScoreChart');
            
            if (!accuracyCanvas || !scoreCanvas) return;
            
            const accuracyCtx = accuracyCanvas.getContext('2d');
            const scoreCtx = scoreCanvas.getContext('2d');
            
            if (accuracyChart && accuracyChart.data) {
                new Chart(accuracyCtx, {
                    type: 'bar',
                    data: accuracyChart.data,
                    options: {
                        responsive: false,
                        animation: false,
                        devicePixelRatio: 2,
                        plugins: { 
                            legend: { display: false },
                            tooltip: { enabled: false }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true, 
                                max: 100, 
                                ticks: { 
                                    font: { size: 12, weight: 'bold' },
                                    color: '#333'
                                },
                                grid: { color: '#ddd' }
                            },
                            x: { 
                                ticks: { 
                                    font: { size: 12, weight: 'bold' },
                                    color: '#333'
                                },
                                grid: { color: '#ddd' }
                            }
                        }
                    }
                });
            }
            
            if (scoreChart && scoreChart.data) {
                new Chart(scoreCtx, {
                    type: 'doughnut',
                    data: scoreChart.data,
                    options: {
                        responsive: false,
                        animation: false,
                        devicePixelRatio: 2,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { 
                                    font: { size: 12, weight: 'bold' },
                                    color: '#333',
                                    padding: 10
                                }
                            },
                            tooltip: { enabled: false }
                        }
                    }
                });
            }
            
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
        
        function getTopPerformersForPDF() {
            const container = document.getElementById('topPerformers');
            if (!container || container.children.length === 0) {
                return '<p style="text-align: center; color: #999; font-style: italic;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
            }
            
            let html = '';
            const performers = Array.from(container.children);
            performers.forEach((item, index) => {
                if (index < 10) {
                    // Get player name from the correct structure
                    const nameDiv = item.querySelector('div:first-child div[style*="font-weight: 600"]');
                    // Get score from the correct structure  
                    const scoreDiv = item.querySelector('div:last-child div[style*="font-size: 1rem"]');
                    
                    if (nameDiv && scoreDiv) {
                        const playerName = nameDiv.textContent.trim();
                        const scoreText = scoreDiv.textContent.trim();
                        
                        html += `
                            <div style="display: flex; justify-content: space-between; padding: 8px; margin-bottom: 5px; border: 1px solid #ddd; border-radius: 3px;">
                                <div style="display: flex; align-items: center;">
                                    <span style="width: 20px; height: 20px; background: ${index === 0 ? 'linear-gradient(135deg, #ffd700, #ffed4e)' : index === 1 ? 'linear-gradient(135deg, #c0c0c0, #e5e5e5)' : index === 2 ? 'linear-gradient(135deg, #cd7f32, #d4a574)' : '#3498db'}; color: ${index < 3 ? '#000' : 'white'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; margin-right: 8px; box-shadow: ${index < 3 ? '0 2px 8px rgba(0,0,0,0.3)' : 'none'};">${index + 1}</span>
                                    <span style="font-size: 12px; color: #3498db; font-weight: bold;">${playerName}</span>
                                </div>
                                <span style="font-weight: bold; color: ${index === 0 ? '#ffd700' : index === 1 ? '#c0c0c0' : index === 2 ? '#cd7f32' : '#333'}; font-size: 12px;">${scoreText}</span>
                            </div>
                        `;
                    }
                }
            });
            return html;
        }
        
        function getDifficultyForPDF() {
            const items = document.querySelectorAll('#difficultyAnalysis .difficulty-item');
            if (items.length === 0) return '<p style="text-align: center; color: #999; font-style: italic;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
            
            let html = '';
            items.forEach((item, index) => {
                if (index < 10) {
                    const questionEl = item.querySelector('div div');
                    const difficultyEl = item.querySelector('.difficulty-badge');
                    if (questionEl && difficultyEl) {
                        const difficulty = difficultyEl.textContent;
                        const colors = { '‡∏á‡πà‡∏≤‡∏¢': '#27ae60', '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á': '#f39c12', '‡∏¢‡∏≤‡∏Å': '#e74c3c', '‡∏¢‡∏≤‡∏Å‡∏°‡∏≤‡∏Å': '#c0392b' };
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin-bottom: 5px; border: 1px solid #ddd; border-radius: 3px;">
                                <span style="font-size: 12px; flex: 1;">${questionEl.textContent}</span>
                                <span style="background: ${colors[difficulty] || '#999'}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: bold;">${difficulty}</span>
                            </div>
                        `;
                    }
                }
            });
            return html;
        }
        
        function getQuestionsForPDF(startIndex = 0, endIndex = null) {
            const questions = document.querySelectorAll('#questionsList .question-item');
            if (questions.length === 0) return '<p style="text-align: center; color: #999; font-style: italic;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
            
            const actualEndIndex = endIndex || questions.length;
            let html = '';
            
            for (let index = startIndex; index < actualEndIndex && index < questions.length; index++) {
                const item = questions[index];
                const questionText = item.querySelector('.question-text');
                const accuracyTexts = item.querySelectorAll('.accuracy-text');
                if (questionText && accuracyTexts.length >= 2) {
                    const ratio = accuracyTexts[0].textContent;
                    const percentage = accuracyTexts[1].textContent;
                    const percentNum = parseInt(percentage);
                    const color = percentNum >= 80 ? '#27ae60' : percentNum >= 60 ? '#f39c12' : percentNum >= 40 ? '#e67e22' : '#e74c3c';
                    
                    html += `
                        <div style="border: 1px solid #ddd; padding: 12px; margin-bottom: 10px; border-radius: 5px; border-left: 4px solid ${color};">
                            <div style="font-weight: bold; margin-bottom: 8px; font-size: 13px;">${questionText.textContent}</div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 11px; color: #666;">‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å: ${ratio}</span>
                                <span style="font-weight: bold; color: ${color}; font-size: 12px;">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥: ${percentage}</span>
                            </div>
                            <div style="background: #f0f0f0; height: 8px; border-radius: 4px; margin-top: 8px; overflow: hidden;">
                                <div style="background: ${color}; height: 100%; width: ${percentNum}%; border-radius: 4px;"></div>
                            </div>
                        </div>
                    `;
                }
            }
            return html;
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤ - ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß
        async function createPDFCharts() {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
            const accuracyCanvas = document.getElementById('pdfAccuracyChart');
            const accuracyCtx = accuracyCanvas.getContext('2d');
            
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏î‡∏¥‡∏°
            const originalAccuracyChart = accuracyChart;
            if (originalAccuracyChart && originalAccuracyChart.data) {
                new Chart(accuracyCtx, {
                    type: 'bar',
                    data: originalAccuracyChart.data,
                    options: {
                        responsive: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, max: 100, ticks: { color: '#333' }, grid: { color: 'rgba(0,0,0,0.1)' } },
                            x: { ticks: { color: '#333' }, grid: { color: 'rgba(0,0,0,0.1)' } }
                        }
                    }
                });
            }
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            const scoreCanvas = document.getElementById('pdfScoreChart');
            const scoreCtx = scoreCanvas.getContext('2d');
            
            const originalScoreChart = scoreChart;
            if (originalScoreChart && originalScoreChart.data) {
                new Chart(scoreCtx, {
                    type: 'doughnut',
                    data: originalScoreChart.data,
                    options: {
                        responsive: false,
                        plugins: { legend: { position: 'bottom', labels: { color: '#333' } } }
                    }
                });
            }
            
            // ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≤‡∏ü render ‡πÄ‡∏™‡∏£‡πá‡∏à
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
        
        function getStatsCardsHTML() {
            return `
                <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #3498db, #2980b9); color: white; border-radius: 12px;">
                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 5px;">${document.getElementById('totalGames').textContent}</div>
                    <div style="font-size: 12px; font-weight: 500;">üéÆ ‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                </div>
                <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; border-radius: 12px;">
                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 5px;">${document.getElementById('totalPlayers').textContent}</div>
                    <div style="font-size: 12px; font-weight: 500;">üë• ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</div>
                </div>
                <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #27ae60, #229954); color: white; border-radius: 12px;">
                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 5px;">${document.getElementById('avgAccuracy').textContent}</div>
                    <div style="font-size: 12px; font-weight: 500;">üéØ ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥</div>
                </div>
                <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #f39c12, #e67e22); color: white; border-radius: 12px;">
                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 5px;">${document.getElementById('avgTime').textContent}</div>
                    <div style="font-size: 12px; font-weight: 500;">‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
                </div>
            `;
        }
        
        function getCompactPerformersHTML() {
            const performers = document.querySelectorAll('#topPerformers .performer-item');
            if (performers.length === 0) {
                return '<div style="text-align: center; color: #7f8c8d; padding: 10px; font-size: 16px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
            }
            
            let html = '';
            performers.forEach((item, index) => {
                const nameElement = item.querySelector('div div div');
                const scoreElement = item.querySelector('div:last-child');
                
                if (nameElement && scoreElement) {
                    const name = nameElement.textContent;
                    const score = scoreElement.textContent;
                    
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; margin-bottom: 8px; background: white; border-radius: 10px; border-left: 5px solid #3498db; font-size: 16px;">
                            <div style="display: flex; align-items: center;">
                                <span style="width: 28px; height: 28px; border-radius: 50%; background: #3498db; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 12px; font-size: 14px;">${index + 1}</span>
                                <span style="font-weight: 600; color: #2c3e50; font-size: 16px;">${name}</span>
                            </div>
                            <span style="font-weight: 700; color: #3498db; font-size: 18px;">${score}</span>
                        </div>
                    `;
                }
            });
            
            return html;
        }
        
        function getCompactDifficultyHTML() {
            const items = document.querySelectorAll('#difficultyAnalysis .difficulty-item');
            if (items.length === 0) {
                return '<div style="text-align: center; color: #7f8c8d; padding: 10px; font-size: 16px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
            }
            
            let html = '';
            items.forEach((item, index) => {
                const questionElement = item.querySelector('div div');
                const difficultyElement = item.querySelector('.difficulty-badge');
                
                if (questionElement && difficultyElement) {
                    const question = questionElement.textContent;
                    const difficulty = difficultyElement.textContent;
                    
                    const difficultyColors = {
                        '‡∏á‡πà‡∏≤‡∏¢': '#27ae60',
                        '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á': '#f39c12',
                        '‡∏¢‡∏≤‡∏Å': '#e74c3c',
                        '‡∏¢‡∏≤‡∏Å‡∏°‡∏≤‡∏Å': '#c0392b'
                    };
                    
                    const color = difficultyColors[difficulty] || '#95a5a6';
                    
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; margin-bottom: 8px; background: white; border-radius: 10px; border-left: 5px solid ${color}; font-size: 16px;">
                            <span style="font-weight: 600; color: #2c3e50; flex: 1; font-size: 16px;">${question}</span>
                            <span style="background: ${color}; color: white; padding: 6px 12px; border-radius: 12px; font-size: 14px; font-weight: 600; margin-left: 10px;">${difficulty}</span>
                        </div>
                    `;
                }
            });
            
            return html;
        }
        
        function getCompactQuestionsHTML() {
            const questions = document.querySelectorAll('#questionsList .question-item');
            if (questions.length === 0) {
                return '<div style="text-align: center; color: #7f8c8d; padding: 10px; font-size: 16px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
            }
            
            let html = '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">';
            
            questions.forEach((item, index) => {
                const questionText = item.querySelector('.question-text');
                const accuracyTexts = item.querySelectorAll('.accuracy-text');
                const accuracyFill = item.querySelector('.accuracy-fill');
                
                if (questionText && accuracyTexts.length >= 2) {
                    const question = questionText.textContent;
                    const ratio = accuracyTexts[0].textContent;
                    const percentage = accuracyTexts[1].textContent;
                    const width = accuracyFill ? accuracyFill.style.width : '0%';
                    
                    const percentageNum = parseInt(percentage);
                    let barColor = '#e74c3c';
                    if (percentageNum >= 80) barColor = '#27ae60';
                    else if (percentageNum >= 60) barColor = '#f39c12';
                    else if (percentageNum >= 40) barColor = '#e67e22';
                    
                    html += `
                        <div style="background: white; border-radius: 12px; padding: 15px; border: 2px solid ${barColor}33;">
                            <div style="font-weight: 600; color: #2c3e50; margin-bottom: 12px; font-size: 16px; line-height: 1.4;">${question}</div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 15px;">
                                <span style="color: #7f8c8d; font-weight: 600;">${ratio}</span>
                                <span style="font-weight: 700; color: #2c3e50; font-size: 16px;">${percentage}</span>
                            </div>
                            <div style="height: 12px; background: #ecf0f1; border-radius: 6px; overflow: hidden;">
                                <div style="height: 100%; background: ${barColor}; width: ${width}; border-radius: 6px;"></div>
                            </div>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            return html;
        }
        

        
        function getTopPerformersHTML(showAll = false, maxItems = 10) {
            const performers = document.querySelectorAll('#topPerformers .performer-item');
            if (performers.length === 0) {
                return '<div style="text-align: center; color: #7f8c8d; padding: 15px; font-size: 12px; font-style: italic;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏•‡πà‡∏ô</div>';
            }
            
            let html = '';
            const limit = showAll ? performers.length : Math.min(maxItems, performers.length);
            
            performers.forEach((item, index) => {
                if (index < limit) {
                    const nameElement = item.querySelector('div div div');
                    const scoreElement = item.querySelector('div:last-child div');
                    const detailElement = item.querySelector('div div div:last-child');
                    
                    if (nameElement && scoreElement) {
                        const name = nameElement.textContent;
                        const score = scoreElement.textContent;
                        const detail = detailElement ? detailElement.textContent : '';
                        
                        const rankColors = ['#ffd700', '#c0c0c0', '#cd7f32', '#3498db'];
                        const rankColor = rankColors[Math.min(index, 3)];
                        const rankBg = index < 3 ? 'linear-gradient(135deg, ' + rankColor + ', ' + rankColor + '88)' : 'linear-gradient(135deg, #3498db, #2980b9)';
                        
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin-bottom: 6px; background: white; border-radius: 8px; border-left: 4px solid ${rankColor}; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <div style="display: flex; align-items: center;">
                                    <div style="width: 24px; height: 24px; border-radius: 50%; background: ${rankBg}; color: ${index < 3 ? '#000' : '#fff'}; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 8px; font-size: 11px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);">${index + 1}</div>
                                    <div>
                                        <div style="font-weight: 600; color: #2c3e50; font-size: 12px; margin-bottom: 2px;">${name}</div>
                                        <div style="font-size: 9px; color: #7f8c8d; font-weight: 400;">${detail}</div>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 14px; font-weight: 700; color: #3498db; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">${score}</div>
                                    <div style="font-size: 8px; color: #95a5a6; font-weight: 500;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                                </div>
                            </div>
                        `;
                    }
                }
            });
            
            return html;
        }
        
        function getDifficultyAnalysisHTML(maxItems = 12) {
            const items = document.querySelectorAll('#difficultyAnalysis .difficulty-item');
            if (items.length === 0) {
                return '<div style="text-align: center; color: #7f8c8d; padding: 15px; font-size: 12px; font-style: italic;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å</div>';
            }
            
            let html = '';
            items.forEach((item, index) => {
                if (index < maxItems) {
                    const questionElement = item.querySelector('div div');
                    const difficultyElement = item.querySelector('.difficulty-badge');
                    const detailElement = item.querySelector('div div:last-child');
                    
                    if (questionElement && difficultyElement) {
                        const question = questionElement.textContent;
                        const difficulty = difficultyElement.textContent;
                        const detail = detailElement ? detailElement.textContent : '';
                        
                        const difficultyColors = {
                            '‡∏á‡πà‡∏≤‡∏¢': '#27ae60',
                            '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á': '#f39c12',
                            '‡∏¢‡∏≤‡∏Å': '#e74c3c',
                            '‡∏¢‡∏≤‡∏Å‡∏°‡∏≤‡∏Å': '#c0392b'
                        };
                        
                        const color = difficultyColors[difficulty] || '#95a5a6';
                        
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin-bottom: 6px; background: white; border-radius: 8px; border-left: 4px solid ${color}; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #2c3e50; font-size: 11px; margin-bottom: 3px; line-height: 1.3;">${question}</div>
                                    <div style="font-size: 9px; color: #7f8c8d; font-weight: 400;">${detail}</div>
                                </div>
                                <div style="margin-left: 8px;">
                                    <div style="background: ${color}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 9px; font-weight: 600; text-align: center; box-shadow: 0 1px 4px rgba(0,0,0,0.2); white-space: nowrap;">${difficulty}</div>
                                </div>
                            </div>
                        `;
                    }
                }
            });
            
            return html;
        }
        
        function getQuestionStatsHTML() {
            const questions = document.querySelectorAll('#questionsList .question-item');
            if (questions.length === 0) {
                return '<div style="text-align: center; color: #7f8c8d; padding: 25px; font-size: 16px; font-style: italic;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</div>';
            }
            
            let html = '';
            questions.forEach((item, index) => {
                const questionText = item.querySelector('.question-text');
                const accuracyTexts = item.querySelectorAll('.accuracy-text');
                const accuracyFill = item.querySelector('.accuracy-fill');
                
                if (questionText && accuracyTexts.length >= 2) {
                    const question = questionText.textContent;
                    const ratio = accuracyTexts[0].textContent;
                    const percentage = accuracyTexts[1].textContent;
                    const width = accuracyFill ? accuracyFill.style.width : '0%';
                    
                    const percentageNum = parseInt(percentage);
                    let barColor = '#e74c3c';
                    let bgGradient = 'linear-gradient(135deg, #fdcbcb, #ffeaa7)';
                    
                    if (percentageNum >= 80) {
                        barColor = '#27ae60';
                        bgGradient = 'linear-gradient(135deg, #d5f4e6, #ffeaa7)';
                    } else if (percentageNum >= 60) {
                        barColor = '#f39c12';
                        bgGradient = 'linear-gradient(135deg, #ffeaa7, #fab1a0)';
                    } else if (percentageNum >= 40) {
                        barColor = '#e67e22';
                        bgGradient = 'linear-gradient(135deg, #fab1a0, #fdcbcb)';
                    }
                    
                    html += `
                        <div style="background: ${bgGradient}; border-radius: 18px; padding: 20px; margin-bottom: 18px; border: 3px solid ${barColor}33; box-shadow: 0 6px 20px rgba(0,0,0,0.15); transition: all 0.3s ease;">
                            <div style="font-weight: 700; color: #2c3e50; margin-bottom: 15px; font-size: 16px; line-height: 1.5; text-shadow: 1px 1px 2px rgba(255,255,255,0.8);">${question}</div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <span style="font-weight: 700; color: #34495e; font-size: 14px; background: rgba(255,255,255,0.7); padding: 5px 12px; border-radius: 12px;">‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å: ${ratio}</span>
                                <span style="font-weight: 800; color: #2c3e50; font-size: 16px; background: rgba(255,255,255,0.9); padding: 6px 15px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥: ${percentage}</span>
                            </div>
                            <div style="background: rgba(255,255,255,0.8); border-radius: 15px; padding: 8px; box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);">
                                <div style="height: 12px; background: #ecf0f1; border-radius: 10px; overflow: hidden; position: relative;">
                                    <div style="height: 100%; background: linear-gradient(90deg, ${barColor}, ${barColor}dd); width: ${width}; border-radius: 10px; transition: width 0.8s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.2); position: relative;">
                                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); animation: shimmer 2s infinite;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            
            return html;
        }

        
        function refreshData() {
            loadAnalyticsData();
            showNotification('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }
        
        function showLoading(show) {
            // Simple loading indicator
            const existing = document.getElementById('loading');
            if (existing) existing.remove();
            
            if (show) {
                const loading = document.createElement('div');
                loading.id = 'loading';
                loading.style.cssText = `
                    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    background: rgba(0,0,0,0.8); color: white; padding: 2rem;
                    border-radius: 10px; z-index: 10000; text-align: center;
                `;
                loading.innerHTML = '<div>üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>';
                document.body.appendChild(loading);
            }
        }
        
        // Register Chart.js datalabels plugin
        Chart.register(ChartDataLabels);
        
        // Load data when page loads
        loadAnalyticsData();
        
        // Auto refresh every 5 minutes
        setInterval(() => {
            const gameSelect = document.getElementById('gameSelect');
            if (gameSelect.value) {
                loadGameDetails(gameSelect.value);
            }
        }, 5 * 60 * 1000);
    </script>
</body>
</html>